<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø­Ø±Ø¨ Ø§Ù„Ø¯ÙˆÙ„ - Ø¹Ø§Ù„Ù… Ú¤Ù„Ù‘Ù‡</title>

<link rel="icon" type="image/png" href="/image/logo2.png">
<link rel="stylesheet" href="../../styles.css" />
<script src="../../ether.js" defer></script>
<!-- Twemoji Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø¹Ù„Ø§Ù… ØªØ´ØªØºÙ„ Ø¨ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© -->
<script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js" defer></script>

<style>

  /* Ù†ÙØ³ Ø§Ù„ØªÙˆØ¨ Ø¨Ø§Ø± Ø­Ù‚ Ù…ÙˆÙ‚Ø¹Ùƒ */
  .site-title{font-weight:900}

  .game-area{ padding:30px; }
  .game-box{
    width:100%; max-width:1100px; height:620px; margin:0 auto;
    background: rgba(0,0,0,0.45); border-radius:24px;
    backdrop-filter: blur(6px); position:relative; overflow:hidden;
    border:1px solid rgba(255,255,255,0.08);
    display:grid; grid-template-columns: 1fr 280px; gap:14px; padding:14px;
  }

  .wheel-zone{position:relative; display:flex; align-items:center; justify-content:center;}
  #wheelCanvas{
    width:520px;height:520px;max-width:90vw;max-height:90vw;
    cursor:pointer;display:block;
  }
  .pointer{
    position:absolute; top:50%; left:50%;
    transform: translate(240px, -50%);
    width:0; height:0;
    border-top:14px solid transparent;
    border-bottom:14px solid transparent;
    border-right:26px solid rgba(255,255,255,0.95);
    filter: drop-shadow(0 0 6px rgba(255,255,255,.6));
  }

  .wheel-controls{
    position:absolute; bottom:10px; left:0; right:0;
    display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
  }
  .btnx{
    padding:10px 16px; border-radius:12px; cursor:pointer;
    background: rgba(255,255,255,0.12);
    border:1px solid rgba(255,255,255,0.2);
    color:#fff; font-weight:800; transition:.15s;
  }
  .btnx:hover{ transform:scale(1.04); }

  .log-zone{
    background: rgba(0,0,0,0.35);
    border-radius:14px; padding:10px; color:#fff; font-size:.95rem;
    overflow:auto; border:1px solid rgba(255,255,255,0.06);
    scrollbar-width: thin;
    scrollbar-color: #2ad3d8 rgba(255,255,255,0.08);
  }
  .log-zone::-webkit-scrollbar{ width:10px; }
  .log-zone::-webkit-scrollbar-track{
    background:rgba(255,255,255,0.05); border-radius:10px; backdrop-filter:blur(4px);
  }
  .log-zone::-webkit-scrollbar-thumb{
    background:linear-gradient(180deg,#2ad3d8,#15d0d4);
    border-radius:10px;border:2px solid rgba(0,0,0,0.4);
    box-shadow:0 0 6px rgba(42,211,216,0.5);
  }
  .log-title{ font-weight:900; margin-bottom:6px; }
  .log-item{ padding:6px 8px; border-bottom:1px dashed rgba(255,255,255,0.08); }

  .join-hint{
    position:absolute; top:18px; right:18px; left:18px; margin:auto; max-width:720px;
    background: rgba(0,0,0,0.55);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:14px; padding:10px 14px; color:#fff; font-weight:800;
    text-align:center; z-index:12; backdrop-filter: blur(6px);
  }

  /* overlays */
  .overlay{
    position:absolute; inset:0; z-index:30;
    background: rgba(0,0,0,0.65);
    display:none; align-items:center; justify-content:center; padding:20px;
  }
  .overlay-card{
    width:min(940px, 95vw);
    background: rgba(20,20,30,0.95);
    border-radius:18px; padding:18px; color:#fff;
    border:1px solid rgba(255,255,255,0.1);
  }
  .winner-banner{
    font-size:1.4rem; font-weight:900; text-align:center; margin-bottom:10px;
  }

  /* flags grid + flip card */
  .flags-grid{
    display:grid; grid-template-columns: repeat(auto-fill, minmax(150px,1fr));
    gap:12px; margin-top:12px; perspective: 1200px;
  }

  .flag-tile{
    position:relative; height:150px; cursor:pointer;
    transform-style:preserve-3d; transition:transform .6s ease;
  }
  .flag-tile.revealed{ transform: rotateY(180deg); }

  .flag-face{
    position:absolute; inset:0; border-radius:14px;
    background: rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.12);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    backface-visibility:hidden;
  }
  .flag-face.front:hover{
    transform: translateZ(2px) scale(1.03);
    box-shadow:0 0 14px rgba(42,211,216,.35);
    border-color: rgba(42,211,216,.6);
  }

  .flag-face.back{
    transform: rotateY(180deg);
    gap:8px;
  }

  .flag-emoji{
    font-size:2.8rem; line-height:1;
    font-family:"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",sans-serif;
  }
  .flag-emoji img.emoji{
    width:46px; height:46px; /* Twemoji svg size */
    vertical-align:middle;
    filter: drop-shadow(0 0 6px rgba(255,255,255,.15));
  }

  .player-avatar{
    width:64px;height:64px;border-radius:50%;object-fit:cover;background:#222;
    border:2px solid rgba(255,255,255,0.18);
    box-shadow:0 0 12px rgba(42,211,216,0.35);
  }
  .player-name{ font-weight:900; font-size:1.05rem; }

  /* manual modal input */
  #manualModal input{
    background: rgba(255,255,255,0.12);
    color:#fff;
    border:1px solid rgba(255,255,255,0.2);
    outline:none;
  }
  #manualModal input::placeholder{
    color: rgba(255,255,255,0.6);
  }

  /* fireworks */
  #fireworksCanvas{
    position:fixed; inset:0; z-index:9998;
    pointer-events:none; display:none;
  }
  .final-banner{
    position:fixed; inset:0; z-index:9999;
    display:none; align-items:center; justify-content:center;
    background: rgba(0,0,0,0.45);
  }
  .final-card{
    background: rgba(10,10,18,0.9);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:18px; color:#fff; padding:20px 24px; text-align:center;
    width:min(520px, 92vw); backdrop-filter: blur(6px);
  }

  @media (max-width: 900px){
    .game-box{ grid-template-columns: 1fr; height:auto; }
    .log-zone{ max-height:220px; }
  }
</style>
</head>

<body>
<canvas id="ether-bg" aria-hidden="true"></canvas>

<div class="top-bar">
  <div class="back-btn" onclick="window.location.href='../../games.html'">Ø±Ø¬ÙˆØ¹</div>

  <!-- âœ… ØµÙ†Ø¯ÙˆÙ‚ Ø­Ø³Ø§Ø¨ ØªÙˆÙŠØªØ´ -->
  <div class="twitch-user-box" id="twitchUserBox">
    <img id="twitchAvatar" src="">
    <span id="twitchUsername">Ø­Ø±Ø¨ Ø§Ù„Ø¯ÙˆÙ„</span>
  </div>

  <h2 class="site-title">Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</h2>
</div>

<div class="game-area">
  <div class="game-box">

    <div class="wheel-zone">
      <canvas id="wheelCanvas" width="520" height="520"></canvas>
      <div class="pointer"></div>

      <div class="join-hint" id="joinHint">
        âœï¸ Ø§ÙƒØªØ¨ <span style="color:#2ad3d8">V9!</span> ÙÙŠ Ø§Ù„Ø´Ø§Øª Ø¹Ø´Ø§Ù† ØªØ¯Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©
      </div>

      <div class="wheel-controls">
        <button class="btnx" id="startToggleBtn">Ø¨Ø¯Ø¡</button>
        <button class="btnx" id="manualAddBtn">+ Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ©</button>
        <button class="btnx" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
    </div>

    <div class="log-zone" id="logZone">
      <div class="log-title">Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
    </div>

    <!-- War Flags Overlay -->
    <div class="overlay" id="warOverlay">
      <div class="overlay-card">
        <div class="winner-banner" id="winnerBanner"></div>
        <div style="text-align:center;opacity:.9">
          Ø§Ø®ØªØ± Ø¹Ù„Ù… â€” Ø¨Ø¹Ø¯Ù‡Ø§ ÙŠÙ†Ù‚Ù„Ø¨ ÙˆÙŠÙƒØ´Ù Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙˆØ±Ø©
        </div>
        <div class="flags-grid" id="flagsGrid"></div>
        <div style="text-align:center;margin-top:12px">
          <button class="btnx" id="cancelWar">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Fireworks -->
<canvas id="fireworksCanvas"></canvas>
<div class="final-banner" id="finalBanner">
  <div class="final-card">
    <h3>ğŸ† Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h3>
    <p id="finalText"></p>
    <button class="btnx" id="restartBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
  </div>
</div>

<!-- Manual Add Modal -->
    <div id="manualModal" class="overlay" style="display:none; z-index:9999;">
      <div class="overlay-card" style="max-width:420px; text-align:center;">
        <h3 style="margin-bottom:10px;">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§</h3>

        <input id="manualName"
               type="text"
               placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ø¯ÙˆÙ† @"
               style="width:100%; padding:10px; border-radius:10px; border:none; margin-bottom:12px;">

        <button class="btnx" id="manualAddConfirm">Ø¥Ø¶Ø§ÙØ©</button>
        <button class="btnx" style="margin-top:8px;" id="manualAddCancel">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>

<script>
/* =========================
   War of Countries - Vallah
========================= */

/* ========== State ========== */
let players = [];   // {name, avatar}
let joinedSet = new Set();

let registrationsOpen = true;
let spinning = false;
let awaitingWarChoice = false;
let winnerIndex = -1;

let angle = 0;
let idleSpinSpeed = 0.0022;

/* ========== DOM ========== */
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");

const startToggleBtn = document.getElementById("startToggleBtn");
const manualAddBtn = document.getElementById("manualAddBtn");
const resetBtn = document.getElementById("resetBtn");
const joinHint = document.getElementById("joinHint");

const logZone = document.getElementById("logZone");

const warOverlay = document.getElementById("warOverlay");
const flagsGrid = document.getElementById("flagsGrid");
const winnerBanner = document.getElementById("winnerBanner");
const cancelWar = document.getElementById("cancelWar");

const manualModal = document.getElementById("manualModal");
const manualName = document.getElementById("manualName");
const manualAddConfirm = document.getElementById("manualAddConfirm");
const manualAddCancel = document.getElementById("manualAddCancel");

/* fireworks DOM */
const fireworksCanvas = document.getElementById("fireworksCanvas");
const fctx = fireworksCanvas.getContext("2d");
const finalBanner = document.getElementById("finalBanner");
const finalText = document.getElementById("finalText");
const restartBtn = document.getElementById("restartBtn");

/* ========== Theme Colors ========== */
const themeColors = ["#164b42", "#0a0f0d", "#134230", "#13382e"];

/* ========== Flags Pool ========== */
const flagPool = [
  "ğŸ‡¸ğŸ‡¦","ğŸ‡®ğŸ‡¶","ğŸ‡°ğŸ‡¼","ğŸ‡¶ğŸ‡¦","ğŸ‡§ğŸ‡­","ğŸ‡´ğŸ‡²","ğŸ‡¦ğŸ‡ª","ğŸ‡¯ğŸ‡´","ğŸ‡±ğŸ‡§","ğŸ‡ªğŸ‡¬","ğŸ‡²ğŸ‡¦","ğŸ‡©ğŸ‡¿","ğŸ‡¹ğŸ‡³","ğŸ‡±ğŸ‡¾","ğŸ‡¸ğŸ‡¾","ğŸ‡¾ğŸ‡ª",
  "ğŸ‡¹ğŸ‡·","ğŸ‡®ğŸ‡·","ğŸ‡µğŸ‡°","ğŸ‡®ğŸ‡³","ğŸ‡¯ğŸ‡µ","ğŸ‡¨ğŸ‡³","ğŸ‡°ğŸ‡·","ğŸ‡·ğŸ‡º","ğŸ‡ºğŸ‡¸","ğŸ‡¨ğŸ‡¦","ğŸ‡²ğŸ‡½","ğŸ‡§ğŸ‡·","ğŸ‡¦ğŸ‡·","ğŸ‡¨ğŸ‡±",
  "ğŸ‡¬ğŸ‡§","ğŸ‡«ğŸ‡·","ğŸ‡©ğŸ‡ª","ğŸ‡®ğŸ‡¹","ğŸ‡ªğŸ‡¸","ğŸ‡³ğŸ‡±","ğŸ‡¸ğŸ‡ª","ğŸ‡³ğŸ‡´","ğŸ‡«ğŸ‡®","ğŸ‡¨ğŸ‡­","ğŸ‡¦ğŸ‡º","ğŸ‡³ğŸ‡¿"
];
/* ========== Ø«Ø§Ø¨Øª: Ø¹Ù„Ù… Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨ ========== */
const flagMap = {};      // { usernameLower: flagEmoji }
let availableFlags = []; // Ù†Ø¹Ø¨Ù‘ÙŠÙ‡Ø§ Ø£ÙˆÙ„ Ù…Ø§ ØªØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©

function refillFlags(){
  availableFlags = shuffle(flagPool);
}
refillFlags();

function assignFlagFor(nameLower){
  if(flagMap[nameLower]) return flagMap[nameLower];

  if(availableFlags.length === 0) refillFlags(); // Ù„Ùˆ Ø®Ù„ØµØª Ø§Ù„Ø£Ø¹Ù„Ø§Ù… Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªØ¯ÙˆÙŠØ±

  const flag = availableFlags.pop();
  flagMap[nameLower] = flag;
  return flag;
}


/* ========== Helpers ========== */
function log(msg){
  const item = document.createElement("div");
  item.className = "log-item";
  item.textContent = msg;
  logZone.appendChild(item);
  logZone.scrollTop = logZone.scrollHeight;
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ========== Draw Wheel ========== */
function drawWheel(){
  const {width:w, height:h} = canvas;
  ctx.clearRect(0,0,w,h);

  const cx = w/2, cy = h/2;
  const radius = w/2 - 10;

  const n = players.length > 0 ? players.length : 8;
  const slice = (Math.PI*2)/n;

  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(angle);

  for(let i=0;i<n;i++){
    const start = i*slice;
    const end = start + slice;

    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,radius,start,end);
    ctx.closePath();
    ctx.fillStyle = themeColors[i % themeColors.length];
    ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,0.22)";
    ctx.lineWidth = 2;
    ctx.stroke();

    if(players.length > 0){
      ctx.save();
      ctx.rotate(start + slice/2);
      ctx.textAlign = "right";
      ctx.fillStyle = "#fff";
      ctx.font = "bold 20px Cairo";
      ctx.fillText(players[i]?.name || "â€”", radius-14, 8);
      ctx.restore();
    }
  }

  ctx.restore();

  ctx.beginPath();
  ctx.arc(cx,cy,56,0,Math.PI*2);
  ctx.fillStyle="rgba(0,0,0,0.85)";
  ctx.fill();
  ctx.strokeStyle="rgba(255,255,255,0.25)";
  ctx.lineWidth=3;
  ctx.stroke();

  ctx.fillStyle="#fff";
  ctx.font="bold 16px Cairo";
  ctx.textAlign="center";
  ctx.fillText("Ú¤Ù„Ù‘Ù‡", cx, cy+6);
}

function pickWinnerFromAngle(){
  const n = players.length;
  const slice = (Math.PI*2)/n;
  let normalized = (Math.PI*2 - (angle % (Math.PI*2))) % (Math.PI*2);
  return Math.floor(normalized / slice) % n;
}
function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

/* ========== Idle Spin ========== */
function idleLoop(){
  if(!spinning && registrationsOpen){
    angle += idleSpinSpeed;
  }
  drawWheel();
  requestAnimationFrame(idleLoop);
}

/* ========== Real Spin ========== */
function spin(){
  if(spinning) return;

  if(registrationsOpen){
    log("âš ï¸ Ø§Ù‚ÙÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø²Ø± (Ø¨Ø¯Ø¡) Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }
  if(players.length < 2){
    log("âš ï¸ Ù„Ø§Ø²Ù… Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ø«Ù†ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
    return;
  }
  if(awaitingWarChoice){
    log("âŒ› ÙÙŠÙ‡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù„Ù… Ø´ØºØ§Ù„.. Ø§Ù†ØªØ¸Ø±.");
    return;
  }

  spinning = true;
  const startAngle = angle;
  const extra = 10*Math.PI*2 + Math.random()*Math.PI*2;
  const endAngle = startAngle + extra;

  const startTime = performance.now();
  const durationMs = 6000;

  log("ğŸŒ€ Ø§Ù„Ø¹Ø¬Ù„Ø© ØªØ¯ÙˆØ±...");

  function animate(now){
    const t = Math.min(1, (now-startTime)/durationMs);
    const e = easeOutCubic(t);
    angle = startAngle + (endAngle-startAngle)*e;
    drawWheel();

    if(t < 1){
      requestAnimationFrame(animate);
    }else{
      spinning = false;
      winnerIndex = pickWinnerFromAngle();
      const winner = players[winnerIndex];

      log(`ğŸ¯ Ø¯ÙˆØ± @${winner.name}`);
      awaitingWarChoice = true;
      showWarOverlay(winner);
    }
  }
  requestAnimationFrame(animate);
}

/* ========== War Overlay (Flip reveal) ========== */
function showWarOverlay(winner){
  winnerBanner.textContent = `@${winner.name} Ø§Ø®ØªØ± Ø¹Ù„Ù… Ø¯ÙˆÙ„Ø©`;
  flagsGrid.innerHTML = "";

  // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒØ±ÙˆØª Ø¹Ø´ÙˆØ§Ø¦ÙŠØŒ Ø¨Ø³ Ø§Ù„Ø¹Ù„Ù… Ø«Ø§Ø¨Øª Ù„Ù„Ø§Ø¹Ø¨
  const displayPlayers = shuffle(players);

  displayPlayers.forEach((p) => {
    const nameLower = p.name.toLowerCase();
    const flag = assignFlagFor(nameLower);

    const tile = document.createElement("div");
    tile.className = "flag-tile";
    tile.innerHTML = `
      <div class="flag-face front">
        <div class="flag-emoji">${flag}</div>
      </div>
      <div class="flag-face back">
        <img class="player-avatar" src="${p.avatar}" onerror="this.src='https://placehold.co/80x80?text=?'">
        <div class="player-name">@${p.name}</div>
      </div>
    `;

    tile.onclick = () => {
      if(tile.classList.contains("revealed")) return;
      [...flagsGrid.children].forEach(x => x.style.pointerEvents="none");
      tile.classList.add("revealed");

      setTimeout(() => {
        warOverlay.style.display="none";
        kickPlayerByName(p.name, winner.name);
      }, 900);
    };

    flagsGrid.appendChild(tile);
  });

  // Twemoji Ù„Ù„Ø£Ø¹Ù„Ø§Ù…
  if(window.twemoji){
    twemoji.parse(flagsGrid, {folder:'svg', ext:'.svg'});
  }

  warOverlay.style.display="flex";
}


function kickPlayerByName(targetName, winnerName){
  const idx = players.findIndex(x => x.name.toLowerCase() === targetName.toLowerCase());
  if(idx === -1){ awaitingWarChoice=false; return; }

  const kicked = players[idx];
  players.splice(idx,1);
  joinedSet.delete(kicked.name.toLowerCase());

  log(`ğŸŒ ÙƒØ§Ù† Ø®Ù„Ù Ø§Ù„Ø¹Ù„Ù…: @${kicked.name}`);
  log(`âŒ @${winnerName} Ø§Ø®ØªØ§Ø± Ø¹Ù„Ù… â†’ Ø§Ù†Ø·Ø±Ø¯ @${kicked.name}`);

  if(idx < winnerIndex) winnerIndex--;

  awaitingWarChoice = false;

  requestAnimationFrame(drawWheel);

  if(players.length === 1){
    const last = players[0];
    log(`ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: @${last.name}`);
    showFinalCelebration(last.name);
  }
}

cancelWar.onclick = ()=>{
  warOverlay.style.display="none";
  awaitingWarChoice = false;
};

/* ========== Controls ========== */
canvas.addEventListener("click", spin);

startToggleBtn.onclick = () => {
  if(spinning || awaitingWarChoice){
    log("âŒ› Ø§Ù†ØªØ¸Ø± Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.");
    return;
  }
  registrationsOpen = !registrationsOpen;
  if(registrationsOpen){
    startToggleBtn.textContent = "Ø¨Ø¯Ø¡";
    joinHint.style.display = "block";
    log("ğŸ”“ ØªÙ… ÙØªØ­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.");
  }else{
    startToggleBtn.textContent = "ÙØªØ­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
    joinHint.style.display = "none";
    log("ğŸš€ Ø¨Ø¯Ø£Ù†Ø§ Ø§Ù„Ø¬ÙˆÙ„Ø©! Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚ÙÙ„.");
  }
};

manualAddBtn.onclick = () => {
  if(!registrationsOpen){
    log("ğŸš« Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚ÙÙ„.");
    return;
  }
  manualName.value = "";
  manualModal.style.display = "flex";
  manualName.focus();
};

manualAddCancel.onclick = () => manualModal.style.display="none";

manualAddConfirm.onclick = () => {
  const raw = manualName.value.trim();
  if(!raw) return;

  const name = raw.replace(/^@/, "").toLowerCase();
  if(joinedSet.has(name)){
    log(`âš ï¸ @${name} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.`);
    manualModal.style.display="none";
    return;
  }

  players.push({
    name,
    avatar: `https://placehold.co/80x80?text=${(name[0]||'?').toUpperCase()}`
  });
  assignFlagFor(name);
  joinedSet.add(name);

  log(`âœ… @${name} Ø¯Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© (ÙŠØ¯ÙˆÙŠ)`);
  manualModal.style.display="none";
  requestAnimationFrame(drawWheel);
};

resetBtn.onclick = resetGame;
restartBtn.onclick = resetGame;

function resetGame(){
  players = [];
  joinedSet.clear();
  angle = 0;
  spinning = false;
  awaitingWarChoice = false;
  winnerIndex = -1;
  registrationsOpen = true;
  startToggleBtn.textContent = "Ø¨Ø¯Ø¡";
  joinHint.style.display = "block";
  finalBanner.style.display="none";
  stopFireworks();
  log("ğŸ” ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©.");
}

/* ========== Fireworks (Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„Ùƒ) ========== */
function resizeFireworks(){
  fireworksCanvas.width = innerWidth;
  fireworksCanvas.height = innerHeight;
}
addEventListener("resize", resizeFireworks);
resizeFireworks();

let fwParticles=[], fwRunning=false, fwTimer=null;

function spawnFirework(){
  const w=fireworksCanvas.width, h=fireworksCanvas.height;
  const x=Math.random()*w*0.9 + w*0.05;
  const y=Math.random()*h*0.35 + h*0.05;
  const colors=["#2ad3d8","#15D0D4","#a84fb5","#7a2fb0","#ffffff"];
  const color=colors[Math.floor(Math.random()*colors.length)];
  const count=60;

  for(let i=0;i<count;i++){
    const ang=(Math.PI*2*i)/count;
    const spd=Math.random()*3+2;
    fwParticles.push({x,y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,life:Math.random()*40+40,color});
  }
}
function fireworksLoop(){
  if(!fwRunning) return;
  const w=fireworksCanvas.width, h=fireworksCanvas.height;
  fctx.clearRect(0,0,w,h);

  fwParticles.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.03; p.life--;
    fctx.globalAlpha=Math.max(0,p.life/80);
    fctx.beginPath(); fctx.arc(p.x,p.y,2.2,0,Math.PI*2);
    fctx.fillStyle=p.color; fctx.fill();
  });

  fwParticles=fwParticles.filter(p=>p.life>0);
  requestAnimationFrame(fireworksLoop);
}
function startFireworks(durationMs=6500){
  fwParticles=[]; fwRunning=true;
  fireworksCanvas.style.display="block";
  spawnFirework();
  fwTimer=setInterval(spawnFirework,650);
  fireworksLoop();
  setTimeout(stopFireworks,durationMs);
}
function stopFireworks(){
  fwRunning=false; fireworksCanvas.style.display="none";
  if(fwTimer) clearInterval(fwTimer); fwTimer=null;
}
function showFinalCelebration(winnerName){
  startFireworks();
  finalText.textContent = `ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù‡Ùˆ: @${winnerName} ğŸ†`;
  finalBanner.style.display="flex";
}

/* Boot */
addEventListener("load", () => {
  drawWheel();
  idleLoop();
  log("âœï¸ Ø§ÙƒØªØ¨ V9! ÙÙŠ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø¯Ø®ÙˆÙ„.");
  log("ğŸŸ£ Ø§Ø¶ØºØ· (Ø¨Ø¯Ø¡) Ù„Ù‚ÙÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø«Ù… Ø§Ø¶ØºØ· Ø§Ù„Ø¹Ø¬Ù„Ø© Ù„Ù„Ù‘Ù.");
});
</script>
<script>
const twitchToken = localStorage.getItem("twitch_access_token");
const twitchUser  = localStorage.getItem("twitch_username");
const TWITCH_CLIENT_ID = "PUT_YOUR_CLIENT_ID_HERE";

const userName   = document.getElementById("twitchUsername");
const userAvatar = document.getElementById("twitchAvatar");

async function loadTwitchUser(){
  if(!twitchToken || !twitchUser){
    userName.textContent = "ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„";
    userAvatar.src = "https://placehold.co/32x32?text=?";
    return;
  }

  try{
    const res = await fetch(`https://api.twitch.tv/helix/users?login=${twitchUser}`, {
      headers:{
        "Client-ID": TWITCH_CLIENT_ID,
        "Authorization": `Bearer ${twitchToken}`
      }
    });

    const data = await res.json();
    if(data.data?.length){
      userName.textContent = data.data[0].display_name;
      userAvatar.src = data.data[0].profile_image_url;
    }
  }catch{
    userName.textContent = twitchUser;
    userAvatar.src = "https://placehold.co/32x32?text=?";
  }
}

loadTwitchUser();
</script>

<footer class="foot"> 2O25 ViRUS, All Rights Reserved Â© </footer>
</body>
</html>
