<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title> Ú¤Ù„Ù‡</title>
<link rel="icon" type="image/png" href="/image/logo2.png">
<link rel="stylesheet" href="../../styles.css" />
<script src="../../ether.js" defer></script>

<style>
  /* Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø§Ø¶ÙŠØ© */
  .game-area{ padding:30px; }
  .game-box{
    width:100%; max-width:1100px; height:620px; margin:0 auto;
    background: rgba(0,0,0,0.45); border-radius:24px;
    backdrop-filter: blur(6px); position:relative; overflow:hidden;
    border:1px solid rgba(255,255,255,0.08);
    display:grid; grid-template-columns: 1fr 280px; gap:14px; padding:14px;
  }

    .wheel-zone{
      position:relative; display:flex; align-items:center; justify-content:center;
      border-radius:18px;
    }
    #wheelCanvas{
      width:520px; height:520px; max-width:90vw; max-height:90vw;
      cursor: pointer;
      display:block;
  }

  .pointer{
    position:absolute; top:50%; left:50%;
    transform: translate(240px, -50%);
    width:0; height:0;
    border-top:14px solid transparent;
    border-bottom:14px solid transparent;
    border-right:26px solid rgba(255,255,255,0.95);
    filter: drop-shadow(0 0 6px rgba(255,255,255,.6));
  }

  .wheel-controls{
    position:absolute; bottom:10px; left:0; right:0;
    display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
  }
  .btnx{
    padding:10px 16px; border-radius:12px; cursor:pointer;
    background: rgba(255,255,255,0.12);
    border:1px solid rgba(255,255,255,0.2);
    color:#fff; font-weight:800;
  }
  .btnx:hover{ transform:scale(1.04); }

  /* ===== Scrollbar Style (Vallah Theme) ===== */
  .log-zone {
    scrollbar-width: thin;
    scrollbar-color: #2ad3d8 rgba(255,255,255,0.08);
  }
  .log-zone::-webkit-scrollbar { width: 10px; }
  .log-zone::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    backdrop-filter: blur(4px);
  }
  .log-zone::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #2ad3d8, #15d0d4);
    border-radius: 10px;
    border: 2px solid rgba(0,0,0,0.4);
    box-shadow: 0 0 6px rgba(42,211,216,0.5);
  }
  .log-zone::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #32e0e6, #19e4e9);
    box-shadow: 0 0 10px rgba(42,211,216,0.8);
  }

  .log-zone{
    background: rgba(0,0,0,0.35);
    border-radius:14px; padding:10px; color:#fff; font-size:.95rem;
    overflow:auto; border:1px solid rgba(255,255,255,0.06);
  }
  .log-title{ font-weight:900; margin-bottom:6px; }
  .log-item{ padding:6px 8px; border-bottom:1px dashed rgba(255,255,255,0.08); }

  .join-hint{
    position:absolute; top:18px; right:18px; left:18px;
    margin:auto; max-width:720px;
    background: rgba(0,0,0,0.55);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:14px;
    padding:10px 14px; color:#fff; font-weight:800;
    text-align:center; z-index:12; backdrop-filter: blur(6px);
  }

  /* Overlay Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‡Ø¯Ù + Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
  .overlay{
    position:absolute; inset:0; z-index:20;
    background: rgba(0,0,0,0.6);
    display:none; align-items:center; justify-content:center; padding:20px;
  }
  .overlay-card{
    width:min(900px, 95vw);
    background: rgba(20,20,30,0.92);
    border-radius:18px; padding:18px; color:#fff;
    border:1px solid rgba(255,255,255,0.1);
  }
  .winner-banner{
    font-size:1.5rem; font-weight:900; text-align:center; margin-bottom:6px;
  }

  .players-grid{
    display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr));
    gap:10px; margin-top:10px;
  }

  .player-tile{
    background: rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:12px; padding:8px; text-align:center; cursor:pointer;
    transition:.2s; position:relative;
  }
  .player-tile:hover{ transform:scale(1.05); box-shadow:0 0 12px rgba(42,211,216,.35); }

  .player-tile.shot-zoom{
    animation: shotZoom 15s ease;
    z-index: 5;
  }
  @keyframes shotZoom{
    0%   { transform: scale(1); }
    35%  { transform: scale(1.10); }
    100% { transform: scale(1); }
  }

  .player-tile.live-flash{
    animation: liveFlash .5s ease;
  }
  @keyframes liveFlash{
    0%   { box-shadow: 0 0 0 rgba(255,0,70,0); }
    30%  { box-shadow: 0 0 20px rgba(255,0,70,.9); border-color: rgba(255,0,70,.9); }
    60%  { box-shadow: 0 0 35px rgba(255,0,70,1); }
    100% { box-shadow: 0 0 0 rgba(255,0,70,0); }
  }

  .player-tile.dead-out{
    filter: grayscale(1) brightness(.7);
    animation: deadOut 1s ease forwards;
  }
  @keyframes deadOut{
    from { opacity: 1; transform: scale(1); }
    to   { opacity: 0; transform: scale(.92); }
  }

  .player-avatar{
    width:60px; height:60px; border-radius:50%; object-fit:cover; margin-bottom:6px;
    background:#222;
  }

  .bullets{
    display:flex; gap:4px; justify-content:center; margin-top:6px; flex-wrap:wrap;
  }
  .bullet{
    width:10px; height:18px; border-radius:2px;
    background: rgba(255,255,255,0.25);
    border:1px solid rgba(255,255,255,0.3);
  }
  .bullet.used{ background: rgba(26, 26, 26, 0.8); }
  .bullet.live{ background: #ff355d; box-shadow:0 0 6px rgba(255,53,93,0.8); }

  .shoot-stage{
    margin-top:12px; display:flex; align-items:center; justify-content:center;
    min-height:80px; font-weight:900; font-size:1.2rem;
  }
  .shoot-stage .gun{
    font-size:2rem; margin-left:10px;
    transform-origin:center; opacity:0;
  }
  .shoot-stage.fire .gun{ animation: gunFire 2s ease; opacity:1; }
  .shoot-stage.empty .gun{ animation: gunEmpty 2s ease; opacity:1; }
  @keyframes gunFire{
    0%{ transform:scale(0.8) rotate(0deg); opacity:0;}
    40%{ transform:scale(1.1) rotate(-8deg); opacity:1;}
    100%{ transform:scale(1) rotate(0deg); opacity:1;}
  }
  @keyframes gunEmpty{
    0%{ transform:scale(0.8); opacity:0;}
    40%{ transform:scale(1); opacity:1;}
    100%{ transform:scale(1); opacity:1;}
  }

  #fireworksCanvas{
    position:fixed; inset:0;
    z-index:9998; pointer-events:none; display:none;
  }
  .final-banner{
    position:fixed; inset:0;
    z-index:9999; display:none; align-items:center; justify-content:center;
    background: rgba(0,0,0,0.45);
  }
  .final-card{
    background: rgba(10,10,18,0.9);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:18px; color:#fff; padding:20px 24px; text-align:center;
    width:min(520px, 92vw); backdrop-filter: blur(6px);
  }

  @media (max-width: 900px){
    .game-box{ grid-template-columns: 1fr; height:auto; }
    .log-zone{ max-height:220px; }
  }

  .player-tile.being-shot{
    animation: shotPulse 0.6s ease;
    border-color: rgba(255,255,255,0.5);
  }
  @keyframes shotPulse{
    0%{ transform:scale(1); filter:brightness(1); }
    30%{ transform:scale(1.06) rotate(-1deg); filter:brightness(1.5); }
    60%{ transform:scale(0.98) rotate(1deg); filter:brightness(0.9); }
    100%{ transform:scale(1); filter:brightness(1); }
  }

  #manualModal input{
    background: rgba(255,255,255,0.12);
    color:#fff;
    border:1px solid rgba(255,255,255,0.2);
    outline:none;
  }
  #manualModal input::placeholder{
    color: rgba(255,255,255,0.6);
  }
</style>
</head>
<body>

<canvas id="ether-bg" aria-hidden="true"></canvas>

<div class="top-bar">
  <div class="back-btn" onclick="window.location.href='../../games.html'">Ø±Ø¬ÙˆØ¹</div>

  <!-- âœ… ØµÙ†Ø¯ÙˆÙ‚ Ø­Ø³Ø§Ø¨ ØªÙˆÙŠØªØ´ -->
  <div class="twitch-user-box" id="twitchUserBox">
    <img id="twitchAvatar" src="">
    <span id="twitchUsername">ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„</span>
  </div>

  <h2 class="site-title">Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</h2>
</div>

<div class="game-area">
  <div class="game-box">

    <div class="wheel-zone">
      <canvas id="wheelCanvas" width="520" height="520"></canvas>
      <div class="pointer"></div>

      <div class="join-hint" id="joinHint">
        âœï¸ Ø§ÙƒØªØ¨ <span style="color:#2ad3d8">V9!</span> ÙÙŠ Ø§Ù„Ø´Ø§Øª Ø¹Ø´Ø§Ù† ØªØ¯Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©
      </div>

      <div class="wheel-controls">
        <button class="btnx" id="startToggleBtn">Ø¨Ø¯Ø¡</button>
        <button class="btnx" id="manualAddBtn">+ Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ©</button>
        <button class="btnx" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
    </div>

    <div class="log-zone" id="logZone">
      <div class="log-title">Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
    </div>

    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‡Ø¯Ù -->
    <div class="overlay" id="targetOverlay">
      <div class="overlay-card">
        <div class="winner-banner" id="winnerBanner"></div>
        <div style="text-align:center;opacity:.9">
          Ø§Ø®ØªØ± Ø´Ø®Øµ ØªØ·Ù„Ù‚ Ø¹Ù„ÙŠÙ‡ â€” Ø¹Ù†Ø¯Ù‡ 6 Ø·Ù„Ù‚Ø§Øª (ÙˆØ­Ø¯Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©)
        </div>

        <div class="shoot-stage" id="shootStage"></div>

        <div class="players-grid" id="playersGrid"></div>

        <div style="text-align:center;margin-top:12px">
          <button class="btnx" id="cancelTarget">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>

    <!-- Manual Add Modal (Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª) -->
    <div id="manualModal" class="overlay" style="display:none; z-index:9999;">
      <div class="overlay-card" style="max-width:420px; text-align:center;">
        <h3 style="margin-bottom:10px;">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§</h3>

        <input id="manualName"
               type="text"
               placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ø¯ÙˆÙ† @"
               style="width:100%; padding:10px; border-radius:10px; border:none; margin-bottom:12px;">

        <button class="btnx" id="manualAddConfirm">Ø¥Ø¶Ø§ÙØ©</button>
        <button class="btnx" style="margin-top:8px;" id="manualAddCancel">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>

  </div>
</div>

<canvas id="fireworksCanvas"></canvas>
<div class="final-banner" id="finalBanner">
  <div class="final-card">
    <h3>ğŸ† Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h3>
    <p id="finalText"></p>
    <button class="btnx" id="restartBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
  </div>
</div>

<audio id="sndEmpty" src="games/roulette/sounds/Empty.m4a" preload="auto"></audio>
<audio id="sndLive" src="games/roulette/sounds/shoot.m4a" preload="auto"></audio>

<script src="tmi.min.js"></script>
<script>
  console.log("tmi READY:", typeof tmi);
</script>

<script>
const BOT_USERNAME = "vallabot";
const BOT_TOKEN = "yhhyqlfr878a0r2zve9lcensv4v13c";
const CHANNEL = localStorage.getItem("twitch_username");
const TWITCH_CLIENT_ID = "t0u3q65s187lx1y839yudlutyvkurc"; // âœ… Ø­Ø· Client ID Ù‡Ù†Ø§
const twitchToken = localStorage.getItem("twitch_access_token");
const twitchUser  = localStorage.getItem("twitch_username");

/* ========= State ========= */
let players = [];  // {name, avatar, chambers:[bool..6], chamberIndex:int}
let joinedSet = new Set();

let registrationsOpen = true;
let spinning = false;
let awaitingShot = false;
let currentWinner = null;
let winnerIndex = -1;

let angle = 0;
let idleSpinSpeed = 0.002;
let channelLogoImg = null;

/* ========= DOM ========= */
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");

const startToggleBtn = document.getElementById("startToggleBtn");
const manualAddBtn = document.getElementById("manualAddBtn");
const resetBtn = document.getElementById("resetBtn");
const joinHint = document.getElementById("joinHint");

const logZone = document.getElementById("logZone");

const targetOverlay = document.getElementById("targetOverlay");
const playersGrid = document.getElementById("playersGrid");
const winnerBanner = document.getElementById("winnerBanner");
const cancelTarget = document.getElementById("cancelTarget");
const shootStage = document.getElementById("shootStage");

const fireworksCanvas = document.getElementById("fireworksCanvas");
const fctx = fireworksCanvas.getContext("2d");
const finalBanner = document.getElementById("finalBanner");
const finalText = document.getElementById("finalText");
const restartBtn = document.getElementById("restartBtn");

const sndEmpty = document.getElementById("sndEmpty");
const sndLive = document.getElementById("sndLive");

/* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© */
const manualModal = document.getElementById("manualModal");
const manualName = document.getElementById("manualName");
const manualAddConfirm = document.getElementById("manualAddConfirm");
const manualAddCancel = document.getElementById("manualAddCancel");

/* ========= Colors ========= */
const themeColors = ["#164b42", "#0a0f0d", "#134230", "#13382e"];
/* ========= Twitch Chat Connection (GAME 2) ========= */

if(!twitchToken || !twitchUser){
  console.warn("âš ï¸ Ù…Ø§ ÙÙŠÙ‡ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙˆÙŠØªØ´ â€” Ø§Ù„Ø´Ø§Øª Ù„Ù† ÙŠØ¹Ù…Ù„");
}else{

  const client = new tmi.Client({
    options: { debug: true },
    connection: { secure: true, reconnect: true },
    identity: {
      username: twitchUser,
      password: "oauth:" + twitchToken
    },
    channels: [ twitchUser ]
  });

  client.connect();

  client.on("connected", () => {
    console.log("âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø¹ Ø´Ø§Øª ØªÙˆÙŠØªØ´");
    log("âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø¹ Ø´Ø§Øª ØªÙˆÙŠØªØ´");
  });

  client.on("message", async (channel, tags, message, self) => {
    if (self) return;

    const text = message.trim().toLowerCase();
    const username = tags.username.toLowerCase();

    /* âœ… Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
    if(text === "!v9"){

      if(!registrationsOpen){
        log(`ğŸš« @${username} Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚ÙÙ„`);
        return;
      }

      if(joinedSet.has(username)){
        log(`âš ï¸ @${username} Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„`);
        return;
      }

      players.push({
        name: username,
        avatar: `https://placehold.co/80x80?text=${username[0]?.toUpperCase()||"?"}`,
        shotsTaken: 0,                         // ÙƒÙ… Ø·Ù„Ù‚Ø© Ø§Ù†Ø·Ù„Ù‚Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨
        liveIndex: Math.floor(Math.random()*6),// Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ù‚Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (0 - 5)
        usedResults: []                        // Ø¹Ø´Ø§Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµØ§Øµ ÙÙŠ Ø§Ù„Ù€ UI
      });


      joinedSet.add(username);
      log(`âœ… @${username} Ø¯Ø®Ù„ Ù…Ù† Ø§Ù„Ø´Ø§Øª`);
      requestAnimationFrame(drawWheel);
    }

    /* âœ… Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ù…Ù† Ø§Ù„Ø´Ø§Øª */
    if(awaitingShot && currentWinner === username){
      if(text.startsWith("@")){
        const target = text.replace("@","").toLowerCase();
        const index = players.findIndex(p => p.name === target);

        if(index !== -1){
          const tile = document.querySelectorAll(".player-tile")[index];
          shootAt(index, players[winnerIndex], tile);
        }
      }
    }

  });

}

function log(msg){
  const item = document.createElement("div");
  item.className = "log-item";
  item.textContent = msg;
  logZone.appendChild(item);
  logZone.scrollTop = logZone.scrollHeight;
}

/* ========= Create chambers ========= */

/* ========= Draw wheel ========= */
  function drawWheel(){
    const {width:w, height:h} = canvas;
    ctx.clearRect(0,0,w,h);

    const cx = w/2, cy = h/2;
    const radius = w/2 - 10;

    const n = players.length > 0 ? players.length : 8;
    const slice = (Math.PI*2)/n;

    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(angle);

    for(let i=0;i<n;i++){
      const start = i*slice;
      const end = start + slice;

      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0,radius,start,end);
      ctx.closePath();
      ctx.fillStyle = themeColors[i % themeColors.length];
      ctx.fill();

      ctx.strokeStyle = "rgba(255,255,255,0.22)";
      ctx.lineWidth = 2;
      ctx.stroke();

      if(players.length > 0){
        ctx.save();
        ctx.rotate(start + slice/2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#fff";
        ctx.font = "bold 20px Cairo";
        ctx.fillText(players[i]?.name || "â€”", radius-14, 8);
        ctx.restore();
      }
    }

    ctx.restore();

    // Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ø¬Ù„Ø©
    ctx.beginPath();
    ctx.arc(cx,cy,56,0,Math.PI*2);
    ctx.fillStyle="rgba(0,0,0,0.85)";
    ctx.fill();
    ctx.strokeStyle="rgba(255,255,255,0.25)";
    ctx.lineWidth=3;
    ctx.stroke();

    if(channelLogoImg && channelLogoImg.complete){
      const r = 48;
      ctx.save();
      ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.clip();
      ctx.drawImage(channelLogoImg, cx-r, cy-r, r*2, r*2);
      ctx.restore();

      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.strokeStyle="rgba(255,255,255,0.35)";
      ctx.lineWidth=2;
      ctx.stroke();
    } else if (twitchUser){
      ctx.fillStyle="#fff";
      ctx.font="bold 16px Cairo";
      ctx.textAlign="center";
      ctx.fillText(twitchUser.toUpperCase(), cx, cy+6);
    }
  }

function pickWinnerFromAngle(){
  const n = players.length;
  const slice = (Math.PI*2)/n;
  let normalized = (Math.PI*2 - (angle % (Math.PI*2))) % (Math.PI*2);
  return Math.floor(normalized / slice) % n;
}
function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

/* ========= Idle spin ========= */
function idleLoop(){
  if(!spinning && registrationsOpen){
    angle += idleSpinSpeed;
  }
  drawWheel();
  requestAnimationFrame(idleLoop);
}

/* ========= Real spin ========= */
function spin(){
  if(spinning) return;

  if(registrationsOpen){
    log("âš ï¸ Ø§Ù‚ÙÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø²Ø± (Ø¨Ø¯Ø¡) Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }
  if(players.length < 2){
    log("âš ï¸ Ù„Ø§Ø²Ù… Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ø«Ù†ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
    return;
  }
  if(awaitingShot){
    log("âŒ› ÙÙŠÙ‡ Ø¥Ø·Ù„Ø§Ù‚ Ø´ØºØ§Ù„.. Ø§Ù†ØªØ¸Ø±.");
    return;
  }

  spinning = true;
  const startAngle = angle;
  const extra = 9*Math.PI*2 + Math.random()*Math.PI*2;
  const endAngle = startAngle + extra;

  const startTime = performance.now();
  const durationMs = 6000;

  log("ğŸŒ€ Ø§Ù„Ø¹Ø¬Ù„Ø© ØªØ¯ÙˆØ±...");

  function animate(now){
    const t = Math.min(1, (now-startTime)/durationMs);
    const e = easeOutCubic(t);
    angle = startAngle + (endAngle-startAngle)*e;
    drawWheel();

    if(t < 1){
      requestAnimationFrame(animate);
    }else{
      spinning = false;
      winnerIndex = pickWinnerFromAngle();
      const winner = players[winnerIndex];
      currentWinner = winner.name.toLowerCase();
      awaitingShot = true;

      log(`ğŸ¯ Ø¯ÙˆØ± @${winner.name}`);
      showTargetOverlay(winner);
    }
  }
  requestAnimationFrame(animate);
}

/* ========= Target overlay ========= */
function renderBullets(target){
  const results = target.usedResults || [];
  const bullets = [];

  for(let i=0;i<6;i++){
    let cls = "bullet";
    if(results[i] === false) cls = "bullet used";
    if(results[i] === true)  cls = "bullet live used";
    bullets.push(`<span class="${cls}"></span>`);
  }
  return `<div class="bullets">${bullets.join("")}</div>`;
}

function showTargetOverlay(winner){
  winnerBanner.textContent = `@${winner.name} Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ ØªØ·Ù„Ù‚ Ø¹Ù„ÙŠÙ‡`;
  shootStage.innerHTML = "";
  playersGrid.innerHTML = "";

  players.forEach((p, i) => {
    if(i === winnerIndex) return;

    const tile = document.createElement("div");
    tile.className="player-tile";
    tile.innerHTML = `
      <img class="player-avatar" src="${p.avatar}" onerror="this.src='https://placehold.co/80x80?text=?'">
      <div>@${p.name}</div>
      ${renderBullets(p)}
    `;
    tile.onclick = () => shootAt(i, winner, tile);
    playersGrid.appendChild(tile);
  });

  targetOverlay.style.display="flex";
}

cancelTarget.onclick = () => {
  targetOverlay.style.display="none";
  awaitingShot = false;
  currentWinner = null;
};

/* ========= Shooting logic ========= */
function playSafe(audioEl){
  try{ audioEl.currentTime = 0; audioEl.play(); }catch(e){}
}

function shootAt(targetIndex, winner, tileEl){
  if(!awaitingShot) return;

  if(targetIndex < 0 || targetIndex >= players.length) return;
  const target = players[targetIndex];

  // Ù„Ùˆ Ø®Ù„ØµØª Ø§Ù„Ø³Øª Ø·Ù„Ù‚Ø§Øª Ø¹Ù„ÙŠÙ‡
  if(target.shotsTaken >= 6){
    log(`ğŸ˜… @${target.name} Ø®Ù„ØµØª Ø·Ù„Ù‚Ø§ØªÙ‡.. Ù†Ø¬Ù‰!`);
    awaitingShot = false;
    currentWinner = null;
    targetOverlay.style.display = "none";
    shootStage.innerHTML = "";
    return;
  }

  awaitingShot = false;
  tileEl?.classList.add("being-shot");

  // âœ… Ù‡Ù†Ø§ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©:
  // Ø£ÙˆÙ„ Ø·Ù„Ù‚Ø© Ø¹Ù„ÙŠÙ‡ = shotsTaken=0
  // Ø¥Ø°Ø§ liveIndex=0 â†’ Ø·Ù„Ù‚Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©
  // Ù„Ùˆ liveIndex=3 â†’ Ø§Ù„Ø·Ù„Ù‚Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø© Ù‡ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
  const isLive = (target.shotsTaken === target.liveIndex);
  target.shotsTaken++;

  // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµØ§Øµ ÙÙŠ UI
  target.usedResults.push(isLive);
  const b = tileEl?.querySelector(".bullets");
  if (b) b.outerHTML = renderBullets(target);

  shootStage.className = "shoot-stage " + (isLive ? "fire" : "empty");
  shootStage.innerHTML = `
    <div style="text-align:center">
      <span class="gun">${isLive ? "ğŸ”«ğŸ”¥" : "ğŸ”«ğŸ’¨"}</span>
      <div style="margin-top:6px;font-size:1.2rem">
        ${isLive ? "ğŸ’¥ Ø·Ù„Ù‚Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©!" : "ğŸ˜® Ø·Ù„Ù‚Ø© ÙØ§Ø¶ÙŠØ©!"}
      </div>
      <button class="btnx" id="continueBtn" style="margin-top:12px">
        Ù…ØªØ§Ø¨Ø¹Ø© â–¶
      </button>
    </div>
  `;

  if(isLive) playSafe(sndLive);
  else playSafe(sndEmpty);

  // Ø²Ø± Ù…ØªØ§Ø¨Ø¹Ø© ÙŠØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„
  setTimeout(() => {
    const btn = document.getElementById("continueBtn");
    if(!btn) return;

    btn.onclick = () => {
      if(isLive){
        // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù…ÙˆØª Ø«Ù… Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨
        tileEl?.classList.add("live-flash");
        setTimeout(() => tileEl?.classList.add("dead-out"), 350);

        setTimeout(() => {
          const kicked = players[targetIndex];
          players.splice(targetIndex,1);
          joinedSet.delete(kicked.name.toLowerCase());

          log(`ğŸ’¥ @${winner.name} Ø£Ø·Ù„Ù‚ Ø¹Ù„Ù‰ @${kicked.name} â€” Ø·Ù„Ù‚Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©!`);

          if(targetIndex < winnerIndex) winnerIndex--;

          targetOverlay.style.display = "none";
          shootStage.innerHTML = "";
          currentWinner = null;

          if(players.length === 1){
            const last = players[0];
            log(`ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: @${last.name}`);
            showFinalCelebration(last.name);
          }else{
            requestAnimationFrame(drawWheel);
          }
        }, 800);

      }else{
        // Ø·Ù„Ù‚Ø© ÙØ§Ø¶ÙŠØ©
        tileEl?.classList.remove("shot-zoom");
        log(`ğŸ˜® @${winner.name} Ø£Ø·Ù„Ù‚ Ø¹Ù„Ù‰ @${target.name} â€” Ø·Ù„Ù‚Ø© ÙØ§Ø¶ÙŠØ©!`);
        targetOverlay.style.display = "none";
        shootStage.innerHTML = "";
        currentWinner = null;
        requestAnimationFrame(drawWheel);
      }
    };
  }, 50);
}

/* ========= Controls ========= */
canvas.addEventListener("click", spin);

startToggleBtn.onclick = () => {
  if(spinning || awaitingShot){
    log("âŒ› Ø§Ù†ØªØ¸Ø± Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.");
    return;
  }
  registrationsOpen = !registrationsOpen;
  if(registrationsOpen){
    startToggleBtn.textContent = "Ø¨Ø¯Ø¡";
    joinHint.style.display = "block";
    log("ğŸ”“ ØªÙ… ÙØªØ­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.");
  }else{
    startToggleBtn.textContent = "ÙØªØ­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
    joinHint.style.display = "none";
    log("ğŸš€ Ø¨Ø¯Ø£Ù†Ø§ Ø§Ù„Ø¬ÙˆÙ„Ø©! Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚ÙÙ„.");
  }
};

/* ========= Manual Add Modal ========= */
manualAddBtn.onclick = () => {
  if(!registrationsOpen){
    log("ğŸš« Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚ÙÙ„.");
    return;
  }
  manualName.value = "";
  manualModal.style.display = "flex";
  manualName.focus();
};

manualAddCancel.onclick = () => {
  manualModal.style.display = "none";
};

manualAddConfirm.onclick = () => {
  const raw = manualName.value.trim();
  if(!raw) return;

  const name = raw.replace(/^@/, "").toLowerCase();
  if(!name) return;

  if(joinedSet.has(name)){
    log(`âš ï¸ @${name} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.`);
    manualModal.style.display = "none";
    return;
  }

  players.push({
    name,
    avatar: `https://placehold.co/80x80?text=${name[0]?.toUpperCase()||"?"}`,
    shotsTaken: 0,
    liveIndex: Math.floor(Math.random()*6),
    usedResults: []
  });


  joinedSet.add(name);
  log(`âœ… @${name} Ø¯Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© (ÙŠØ¯ÙˆÙŠ)`);
  manualModal.style.display = "none";
  requestAnimationFrame(drawWheel);
};

resetBtn.onclick = resetGame;
restartBtn.onclick = resetGame;

function resetGame(){
  players = [];
  joinedSet.clear();
  angle = 0;
  spinning = false;
  awaitingShot = false;
  currentWinner = null;
  winnerIndex = -1;
  registrationsOpen = true;
  startToggleBtn.textContent = "Ø¨Ø¯Ø¡";
  joinHint.style.display = "block";
  finalBanner.style.display="none";
  stopFireworks();
  log("ğŸ” ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©.");
}

/* ========= Fireworks ========= */
function resizeFireworks(){
  fireworksCanvas.width = window.innerWidth;
  fireworksCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeFireworks);
resizeFireworks();

let fwParticles = [];
let fwRunning = false;
let fwTimer = null;

function spawnFirework(){
  const w = fireworksCanvas.width, h = fireworksCanvas.height;
  const x = Math.random()*w*0.9 + w*0.05;
  const y = Math.random()*h*0.35 + h*0.05;

  const colors = ["#2ad3d8","#15D0D4","#a84fb5","#7a2fb0","#ffffff"];
  const color = colors[Math.floor(Math.random()*colors.length)];

  const count = 60;
  for(let i=0;i<count;i++){
    const ang = (Math.PI*2*i)/count;
    const spd = Math.random()*3 + 2;
    fwParticles.push({
      x,y, vx: Math.cos(ang)*spd, vy: Math.sin(ang)*spd,
      life: Math.random()*40 + 40, color
    });
  }
}

function fireworksLoop(){
  if(!fwRunning) return;
  const w = fireworksCanvas.width, h = fireworksCanvas.height;
  fctx.clearRect(0,0,w,h);

  fwParticles.forEach(p=>{
    p.x += p.vx; p.y += p.vy; p.vy += 0.03; p.life--;
    fctx.globalAlpha = Math.max(0, p.life/80);
    fctx.beginPath(); fctx.arc(p.x,p.y,2.2,0,Math.PI*2);
    fctx.fillStyle = p.color; fctx.fill();
  });

  fwParticles = fwParticles.filter(p=>p.life>0);
  requestAnimationFrame(fireworksLoop);
}

function startFireworks(durationMs=6500){
  fwParticles = []; fwRunning = true;
  fireworksCanvas.style.display="block";
  spawnFirework();
  fwTimer = setInterval(spawnFirework, 650);
  fireworksLoop();
  setTimeout(stopFireworks, durationMs);
}

function stopFireworks(){
  fwRunning = false; fireworksCanvas.style.display="none";
  if(fwTimer) clearInterval(fwTimer); fwTimer = null;
}

function showFinalCelebration(winnerName){
  startFireworks();
  finalText.textContent = `ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù‡Ùˆ: @${winnerName} ğŸ†`;
  finalBanner.style.display="flex";
}
/* ========= Load Channel Logo (Center Image) ========= */
async function loadChannelLogo(){
  if(!twitchUser || !twitchToken){
    console.warn("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù‚Ù†Ø§Ø© â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„");
    return;
  }

  try{
    const res = await fetch(`https://api.twitch.tv/helix/users?login=${twitchUser}`, {
      headers: {
        "Client-ID": TWITCH_CLIENT_ID,
        "Authorization": `Bearer ${twitchToken}`
      }
    });

    const data = await res.json();
    console.log("âœ… Twitch Logo Data:", data);

    if(!data.data || !data.data.length){
      console.error("âŒ Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨");
      return;
    }

    const url = data.data[0].profile_image_url;

    const img = new Image();
    img.crossOrigin = "anonymous";

    img.onload = () => {
      channelLogoImg = img;
      console.log("âœ… ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø§Ù‡Ø²Ø©");
      drawWheel();
    };

    img.onerror = () => {
      console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©");
    };

    img.src = url;

  }catch(err){
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Ø§Ù„Ù‚Ù†Ø§Ø©:", err);
  }
}

/* ========= Boot ========= */
window.addEventListener("load", () => {
  drawWheel();
  idleLoop();
  log("âœï¸ Ø§ÙƒØªØ¨ V9! ÙÙŠ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø¯Ø®ÙˆÙ„.");
  log("ğŸŸ£ Ø¹Ù†Ø¯ Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± (Ø¨Ø¯Ø¡) ÙŠÙ‚ÙÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ù„Ø¹Ø¨Ø© ØªØ¨Ø¯Ø£.");

  // âœ… ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ ÙˆØ³Ø· Ø§Ù„Ø¹Ø¬Ù„Ø©
  setTimeout(loadChannelLogo, 1000);
});
</script>

<script>

const userName   = document.getElementById("twitchUsername");
const userAvatar = document.getElementById("twitchAvatar");

async function loadTwitchUser(){
  if(!twitchToken || !twitchUser){
    console.warn("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙˆÙŠØªØ´");
    userName.textContent = "ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„";
    userAvatar.src = "https://placehold.co/32x32?text=?";
    return;
  }

  try{
    const res = await fetch(`https://api.twitch.tv/helix/users?login=${twitchUser}`, {
      headers:{
        "Client-ID": TWITCH_CLIENT_ID,
        "Authorization": `Bearer ${twitchToken}`
      }
    });

    const data = await res.json();
    console.log("âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙˆÙ‚:", data);

    if(data.data && data.data.length){

      const avatarUrl = data.data[0].profile_image_url;

      // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…
      userName.textContent = data.data[0].display_name;

      // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø´ÙƒÙ„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ (ØªÙØ±ÙŠØº Ø§Ù„ÙƒØ§Ø´)
      userAvatar.src = avatarUrl + "?v=" + Date.now();

      userAvatar.onerror = () => {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨");
        userAvatar.src = "https://placehold.co/32x32?text=?";
      };

      console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:", avatarUrl);

    }else{
      console.warn("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
    }

  }catch(err){
    console.error("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", err);
  }
}
loadTwitchUser();

</script>

<footer class="foot"> 2O25 ViRUS, All Rights Reserved Â© </footer>
</body>
</html>
