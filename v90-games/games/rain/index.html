<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ú¤Ù„Ù‡ - Ø³Ø±Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø¨Ø¯ÙŠÙ‡Ø©</title>
<link rel="icon" type="image/png" href="/image/logo2.png">

<link rel="stylesheet" href="../../styles.css" />
<script src="../../ether.js" defer></script>

<style>
  .game-area{ padding:30px; }
  .game-box{
    width:100%; max-width:1100px; height:640px; margin:0 auto;
    background: rgba(0,0,0,0.45); border-radius:24px;
    backdrop-filter: blur(6px); position:relative; overflow:hidden;
    border:1px solid rgba(255,255,255,0.08);
    display:grid; grid-template-columns: 260px 1fr 260px; gap:14px; padding:14px;
  }

  /* ÙŠØ³Ø§Ø±: Ø§Ù„Ù†Ù‚Ø§Ø· */
  .scores-zone{
    background: rgba(0,0,0,0.35);
    border-radius:14px; padding:10px; color:#fff; font-size:.95rem;
    overflow:auto; border:1px solid rgba(255,255,255,0.06);
  }
  .scores-title{ font-weight:900; margin-bottom:6px; text-align:center; }
  .score-item{
    display:flex; justify-content:space-between; padding:6px 8px;
    border-bottom:1px dashed rgba(255,255,255,0.08);
  }
  .score-item .name{ font-weight:800; }
  .score-item .pts{ color:#2ad3d8; font-weight:900; }

  /* ÙˆØ³Ø·: Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª */
  .rain-zone{
    position:relative; border-radius:18px; overflow:hidden;
    background: rgba(5,5,10,0.7);
    border:1px solid rgba(255,255,255,0.06);
  }
  .rain-stage{
    position:absolute; inset:0;
  }

  /* ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø£Ø­Ø¯Ø§Ø« + Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
  .right-zone{
    display:flex; flex-direction:column; gap:10px;
  }
.log-zone{
  flex: 1;
  min-height: 240px;     /* âœ… Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª */
  max-height: 240px;     /* âœ… Ù„Ø§ ÙŠÙƒØ¨Ø± Ø¨Ø¹Ø¯Ù‡ */
  background: rgba(0,0,0,0.35);
  border-radius:14px;
  padding:10px;
  color:#fff;
  font-size:.95rem;
  overflow-y: auto;      /* âœ… Ø³ÙƒØ±ÙˆÙ„ ÙÙ‚Ø· */
  overflow-x: hidden;
  border:1px solid rgba(255,255,255,0.06);
}

.log-zone::-webkit-scrollbar {
  width: 8px;
}
.log-zone::-webkit-scrollbar-thumb {
  background: linear-gradient(#2ad3d8, #15d0d4);
  border-radius: 20px;
}

  .log-zone{ flex:1; }
  .log-title, .settings-title{
    font-weight:900; margin-bottom:6px; text-align:center;
  }
  .log-item{ padding:6px 8px; border-bottom:1px dashed rgba(255,255,255,0.08); }

  .settings-zone label{ font-size:.9rem; display:block; margin-top:6px; }
.settings-zone select{
  width:100%;
  margin-top:6px;
  padding:10px 12px;
  border-radius:12px;
  background: rgba(20,20,30,0.75);
  color:#fff;
  border:1px solid rgba(255,255,255,0.2);
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  cursor:pointer;
  font-weight:700;
  background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat:no-repeat;
  background-position: left 12px center;
  background-size:18px;
}
  .settings-zone .btnx{
    width:100%; margin-top:8px; padding:10px 12px; border-radius:10px;
    cursor:pointer; background: rgba(255,255,255,0.12);
    border:1px solid rgba(255,255,255,0.2); color:#fff; font-weight:900;
  }
  .settings-zone .btnx:hover{ transform:scale(1.02); }

  /* Overlay Ø§Ù„Ø³Ø¤Ø§Ù„ */
  .overlay{
    position:absolute; inset:0; z-index:50;
    background: rgba(0,0,0,0.7);
    display:none; align-items:center; justify-content:center; padding:20px;
  }
.overlay-card{
  width: min(720px, 95vw);
  height: 360px;                /* âœ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
  background: rgba(15,15,25,0.95);
  border-radius:18px;
  padding:18px;
  color:#fff;
  border:1px solid rgba(255,255,255,0.1);
  text-align:center;

  display: flex;                /* âœ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ */
  flex-direction: column;
  justify-content: center;
  align-items: center;

  overflow: hidden;             /* âœ… ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ…Ø¯Ø¯ */
}
  .big{
    font-size:2rem; font-weight:900; margin:8px 0;
  }
  .muted{ opacity:.9; }

.question-emoji{
  font-size: 64px;        /* âœ… Ø­Ø¬Ù… Ø«Ø§Ø¨Øª */
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 12px 0;
}

  .final-banner{
    position:fixed; inset:0; z-index:9999;
    display:none; align-items:center; justify-content:center;
    background: rgba(0,0,0,0.45);
  }
  .final-card{
    background: rgba(10,10,18,0.9);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:18px; color:#fff; padding:20px 24px; text-align:center;
    width:min(520px, 92vw); backdrop-filter: blur(6px);
  }

  .restart-btn{
    margin-top:12px;
    padding:12px 18px;
    border-radius:14px;
    background: linear-gradient(135deg,#22d67c,#2caa0d);
    color:#000;
    font-weight:900;
    border:none;
    cursor:pointer;
    box-shadow: 0 0 14px rgba(42, 216, 65, 0.6);
  }

  .restart-btn:hover{
    transform:scale(1.08);
  }

  #fireworksCanvas{
    position:fixed; inset:0;
    z-index:9998; pointer-events:none; display:none;
  }

  @media (max-width: 1000px){
    .game-box{ grid-template-columns: 1fr; height:auto; }
    .right-zone{ order:3; }
    .scores-zone{ max-height:220px; }
    .log-zone{ max-height:220px; }
  }

.num-control{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  margin:8px 0 12px 0;
}

.num-display{
  min-width:60px;
  text-align:center;
  padding:8px 0;
  border-radius:12px;
  font-weight:900;
  font-size:1.05rem;
  color:#fff;
  background: linear-gradient(135deg, #181a1f, #0f1115);
  border:1px solid rgba(42,211,216,0.35);
  box-shadow: 0 0 10px rgba(42,211,216,0.25);
}

.num-btn{
  width:34px;
  height:34px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.25);
  background: rgba(255,255,255,0.08);
  color:#fff;
  font-size:20px;
  font-weight:900;
  cursor:pointer;
  transition:.15s;
}

.num-btn:hover{
  transform:scale(1.1);
  background: rgba(42,211,216,0.25);
  box-shadow: 0 0 8px rgba(42,211,216,0.4);
}

</style>
</head>
<body>

<canvas id="ether-bg" aria-hidden="true"></canvas>

<div class="top-bar">
  <div class="back-btn" onclick="window.location.href='../../games.html'">Ø±Ø¬ÙˆØ¹</div>

  <!-- âœ… ØµÙ†Ø¯ÙˆÙ‚ Ø­Ø³Ø§Ø¨ ØªÙˆÙŠØªØ´ -->
  <div class="twitch-user-box" id="twitchUserBox">
    <img id="twitchAvatar" src="">
    <span id="twitchUsername">ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„</span>
  </div>

  <h2 class="site-title">Ø³Ø±Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø¨Ø¯ÙŠÙ‡Ø©</h2>
</div>

<div class="game-area">
  <div class="game-box">

    <!-- Scores -->
    <div class="scores-zone" id="scoresZone">
      <div class="scores-title">Ø§Ù„Ù†Ù‚Ø§Ø·</div>
      <div id="scoresList"></div>
    </div>

    <!-- Emoji Area -->
    <div class="rain-zone">
      <div class="rain-stage" id="rainStage"></div>

      <div class="overlay" id="overlay">
        <div class="overlay-card" id="overlayCard"></div>
      </div>
    </div>

    <!-- Right -->
    <div class="right-zone">
      <div class="settings-zone" id="settingsZone">
        <div class="settings-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</div>

        <label>Ù…Ø¯Ø© Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ² (Ø«ÙˆØ§Ù†ÙŠ)</label>
          <div class="num-control">
          <button class="num-btn" onclick="changeDuration(-1)">âˆ’</button>
          <span id="durationDisplay" class="num-display">4</span>
          <button class="num-btn" onclick="changeDuration(1)">+</button>
        </div>
        <input id="durationInput" type="hidden" value="4">

        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</label>
          <div class="num-control">
          <button class="num-btn" onclick="changeRounds(-1)">âˆ’</button>
          <span id="roundsDisplay" class="num-display">5</span>
          <button class="num-btn" onclick="changeRounds(1)">+</button>
        </div>
        <input id="roundsInput" type="hidden" value="5">

        <button class="btnx" id="startGameBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        <button class="btnx" id="openCloseBtn" style="display:none">Ø¥ÙŠÙ‚Ø§Ù</button>
        <span id="roundsDisplay">5</span>
        <span id="durationDisplay">10</span>


      </div>

      <div class="log-zone" id="logZone">
        <div class="log-title">Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
      </div>
    </div>
  </div>
</div>

<canvas id="fireworksCanvas"></canvas>
<div class="final-banner" id="finalBanner">
  <div class="final-card">
    <h3>ğŸ† Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h3>
    <p id="finalText"></p>
    <button class="restart-btn" id="restartBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
  </div>
</div>

<!-- Twitch -->
<script src="tmi.min.js"></script>
<script>
  console.log("tmi READY:", typeof tmi);
</script>

<script>
/* ======================
   Ù„Ø¹Ø¨Ø© Ø³Ø±Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø¨Ø¯ÙŠÙ‡Ø©
   Ø¨Ù†Ø¸Ø§Ù… "Ù„Ù‚Ø·Ø© Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª"
====================== */

/* === Twitch Config === */
const TWITCH_CLIENT_ID = "t0u3q65s187lx1y839yudlutyvkurc"; // ğŸ”‘ Client ID Ø­Ù‚Ùƒ
const twitchToken = localStorage.getItem("twitch_access_token");
const twitchUser  = localStorage.getItem("twitch_username");

/* === DOM === */
const rainStage = document.getElementById("rainStage");
const overlay = document.getElementById("overlay");
const overlayCard = document.getElementById("overlayCard");
const logZone = document.getElementById("logZone");
const scoresList = document.getElementById("scoresList");

const roundsInput = document.getElementById("roundsInput");
const durationInput = document.getElementById("durationInput");
const difficultySelect = document.getElementById("difficultySelect");
const startGameBtn = document.getElementById("startGameBtn");
const openCloseBtn = document.getElementById("openCloseBtn");

const fireworksCanvas = document.getElementById("fireworksCanvas");
const fctx = fireworksCanvas.getContext("2d");
const finalBanner = document.getElementById("finalBanner");
const finalText = document.getElementById("finalText");
const restartBtn = document.getElementById("restartBtn");

/* === State === */
let gameRunning = false;
let acceptingAnswers = false;

let totalRounds = 5;
let roundDuration = 4;   // Ù…Ø¯Ø© Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª
let difficulty = "normal";
let currentRound = 0;

let emotePool = [];      // {type:"img"|"text", key, text?, url?}
let currentEmojis = [];  // Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

let targetEmoteKey = null;
let targetEmoteDisplay = null;
let correctAnswer = null;

let answerTimeout = null;
let scores = new Map();  // username -> points
let answeredThisRound = false;

/* === Helpers === */
function log(msg){
  const item = document.createElement("div");
  item.className = "log-item";
  item.textContent = msg;
  logZone.appendChild(item);
  logZone.scrollTop = logZone.scrollHeight;
}
function updateScores(){
  const arr = [...scores.entries()].sort((a,b)=>b[1]-a[1]);
  scoresList.innerHTML = arr.map(([name,pts]) => `
    <div class="score-item">
      <span class="name">@${name}</span>
      <span class="pts">${pts}</span>
    </div>
  `).join("") || `<div class="muted" style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· Ø¨Ø¹Ø¯</div>`;
}
function arabicToEnglishDigits(str){
  const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  return str.replace(/[Ù -Ù©]/g, d => map[d]);
}
function extractNumber(msg){
  const cleaned = arabicToEnglishDigits(msg);
  const m = cleaned.match(/(\d+)/);
  return m ? parseInt(m[1],10) : null;
}
function changeRounds(val){
  let v = parseInt(roundsInput.value || 1);
  v += val;
  if(v < 1) v = 1;
  if(v > 20) v = 20;
  roundsInput.value = v;
  document.getElementById("roundsDisplay").textContent = v;
}

function changeDuration(val){
  let v = parseInt(durationInput.value || 4);
  v += val;
  if(v < 2) v = 2;
  if(v > 60) v = 60;
  durationInput.value = v;
  document.getElementById("durationDisplay").textContent = v;
}

/* === Emotes === */
const fallbackEmojis = ["ğŸ˜‚","ğŸ”¥","ğŸ˜º","ğŸ˜","ğŸ‰","ğŸ’€","ğŸ¸","ğŸ¤¯","âœ¨","ğŸ•","âš¡","ğŸ§ ","ğŸš€","ğŸ’™","ğŸ¤","ğŸ˜ˆ","ğŸª","ğŸŒ§ï¸","ğŸ¦…","ğŸ§¨"];

function setFallbackPool(){
  emotePool = fallbackEmojis.map(e => ({
    type:"text",
    text:e,
    key:e
  }));
}

async function fetchBroadcasterEmotes(){
  if(!TWITCH_CLIENT_ID || !twitchToken || !twitchUser){
    setFallbackPool();
    return;
  }

  try{
    // 1) get broadcaster id
    const uRes = await fetch(`https://api.twitch.tv/helix/users?login=${twitchUser}`,{
      headers:{
        "Client-ID": TWITCH_CLIENT_ID,
        "Authorization": `Bearer ${twitchToken}`
      }
    });
    const uJson = await uRes.json();
    const broadcasterId = uJson.data?.[0]?.id;
    if(!broadcasterId){
      setFallbackPool();
      return;
    }

    // 2) get channel emotes
    const eRes = await fetch(`https://api.twitch.tv/helix/chat/emotes?broadcaster_id=${broadcasterId}`,{
      headers:{
        "Client-ID": TWITCH_CLIENT_ID,
        "Authorization": `Bearer ${twitchToken}`
      }
    });
    const eJson = await eRes.json();
    const emotes = eJson.data || [];

    if(!emotes.length){
      setFallbackPool();
      return;
    }

    emotePool = emotes.map(em => ({
      type:"img",
      url: em.images?.url_2x || em.images?.url_1x,
      key: em.name || em.id
    }));

  }catch(err){
    setFallbackPool();
  }
}

/* === Difficulty Settings (Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª + Ù…Ø¯Ø© Ø¸Ù‡ÙˆØ±Ù‡Ø§) === */
function difficultySettings(level){
  const baseShow = Number(durationInput.value) || 4; // Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  switch(level){
    case "easy":   return {count: 12, showMs: baseShow*1000};
    case "hard":   return {count: 22, showMs: Math.max(2000, baseShow*800)};
    case "insane": return {count: 35, showMs: Math.max(1500, baseShow*600)};
    default:       return {count: 18, showMs: baseShow*1000};
  }
}

/* === Ø¥Ø¸Ù‡Ø§Ø± Ø¯ÙØ¹Ø© Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª ÙˆØ§Ø­Ø¯Ø© === */
function showEmojiBatch(){
  rainStage.innerHTML = "";
  currentEmojis = [];

  const { count, showMs } = difficultySettings(difficulty);
  if(!emotePool.length) setFallbackPool();

  const stageRect = rainStage.getBoundingClientRect();

  for(let i=0;i<count;i++){
    const em = emotePool[Math.floor(Math.random()*emotePool.length)];
    currentEmojis.push(em);

    const el = document.createElement(em.type === "img" ? "img" : "div");
    el.style.position = "absolute";
    el.style.transform = "translate(-50%, -50%)";

    const x = Math.random()*80 + 10; // 10% - 90%
    const y = Math.random()*70 + 10; // 10% - 80%
    el.style.left = x + "%";
    el.style.top  = y + "%";

    if(em.type === "img"){
      el.src = em.url;
      el.style.width  = "60px";
      el.style.height = "60px";
    }else{
      el.textContent = em.text;
      el.style.fontSize = "48px";
      el.style.lineHeight = "48px";
    }

    rainStage.appendChild(el);
  }

  // Ø¨Ø¹Ø¯ Ù…Ø¯Ø© Ø§Ù„Ø¸Ù‡ÙˆØ±: Ù†Ø®ÙÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª ÙˆÙ†Ø·Ù„Ø¹ Ø§Ù„Ø³Ø¤Ø§Ù„
  setTimeout(()=>{
    rainStage.innerHTML = "";
    showQuestion();
  }, showMs);
}

/* === Overlay Helpers === */
function showOverlay(html){
  overlayCard.innerHTML = html;
  overlay.style.display = "flex";
}
function hideOverlay(){
  overlay.style.display = "none";
}

function countdown(seconds, onDone){
  let t = seconds;
  showOverlay(`
    <div class="big">ØªØ¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø¨Ø¹Ø¯</div>
    <div class="big" id="cdNum">${t}</div>
  `);
  const id = setInterval(()=>{
    t--;
    const el = document.getElementById("cdNum");
    if(el) el.textContent = t;
    if(t<=0){
      clearInterval(id);
      hideOverlay();
      onDone();
    }
  },1000);
}

/* === Ø§Ø®ØªÙŠØ§Ø± Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ø³Ø¤Ø§Ù„ === */
function pickRandomTarget(){
  const appeared = {};
  currentEmojis.forEach(e=>{
    appeared[e.key] = (appeared[e.key] || 0) + 1;
  });

  const keys = Object.keys(appeared);
  if(!keys.length){
    // Ø§Ø­ØªÙŠØ§Ø· Ù„Ùˆ ØµØ§Ø± Ø®Ø·Ø£
    targetEmoteKey = fallbackEmojis[0];
    correctAnswer = 0;
    targetEmoteDisplay = `<div class="question-emoji">${targetEmoteKey}</div>`;
    return;
  }

  targetEmoteKey = keys[Math.floor(Math.random()*keys.length)];
  correctAnswer = appeared[targetEmoteKey];

  const em = emotePool.find(e=>e.key===targetEmoteKey);
  if(em?.type === "img"){
    targetEmoteDisplay = `<img src="${em.url}" alt="${targetEmoteKey}" style="width:90px;height:90px">`;
  }else{
    targetEmoteDisplay = `<div class="question-emoji">${em?.text || targetEmoteKey}</div>`;
  }
}

/* === Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© === */
function showQuestion(){
  if(!currentEmojis.length){
    log("âš ï¸ Ù…Ø§ ÙƒØ§Ù† ÙÙŠÙ‡ Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª ÙƒÙØ§ÙŠØ©ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø¬ÙˆÙ„Ø©.");
    nextRound();
    return;
  }

  pickRandomTarget();
  answeredThisRound = false;
  acceptingAnswers = true;

  showOverlay(`
    <div class="big">ÙƒÙ… Ù…Ø±Ø© Ø¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØŸ</div>
    ${targetEmoteDisplay}
    <div class="muted">Ø£ÙˆÙ„ ÙˆØ§Ø­Ø¯ ÙŠØ¬Ø§ÙˆØ¨ ØµØ­ Ù…Ù† Ø´Ø§Øª ØªÙˆÙŠØªØ´ ÙŠØ§Ø®Ø° Ù†Ù‚Ø·Ø©</div>
    <div class="muted" style="margin-top:6px">â³ Ø¹Ù†Ø¯ÙƒÙ… 30 Ø«Ø§Ù†ÙŠØ©</div>
  `);

  log(`â“ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬ÙˆÙ„Ø© ${currentRound}: ÙƒÙ… Ø¹Ø¯Ø¯ "${targetEmoteKey}" ØŸ`);

  answerTimeout = setTimeout(()=>{
    acceptingAnswers = false;
    hideOverlay();
    if(!answeredThisRound){
      log("âŒ› Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚ØªØŒ Ù…Ø§ ÙÙŠ ÙØ§Ø¦Ø² Ø¨Ù‡Ø§Ù„Ø¬ÙˆÙ„Ø©.");
    }
    nextRound();
  }, 30000);
}

/* === Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¬ÙˆÙ„Ø§Øª === */
function nextRound(){
  clearTimeout(answerTimeout);
  answerTimeout = null;
  acceptingAnswers = false;
  hideOverlay();

  if(currentRound >= totalRounds){
    endGame();
    return;
  }

  setTimeout(()=> startRound(), 1200);
}

function startRound(){
  currentRound++;
  log(`ğŸ¯ Ø¨Ø¯Ø£Øª Ø§Ù„Ø¬ÙˆÙ„Ø© ${currentRound}/${totalRounds}`);
  countdown(3, showEmojiBatch);
}

/* === Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø£Ø²Ø±Ø§Ø±) === */
startGameBtn.onclick = async ()=> {

  if(gameRunning) return;

  // âœ… Ù†Ø§Ø®Ø° Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØµÙŠ ÙˆÙ„ÙŠØ³ Ù…Ù† input
  totalRounds   = parseInt(document.getElementById("roundsDisplay")?.textContent || "5");
  roundDuration = parseInt(document.getElementById("durationDisplay")?.textContent || "10");
  difficulty    = difficultySelect?.value || "normal";

  await fetchBroadcasterEmotes();

  gameRunning = true;
  currentRound = 0;
  scores.clear();
  updateScores();
  log("ğŸš€ ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©!");

  openCloseBtn.style.display = "block";
  startGameBtn.style.display = "none";

  startRound();
};

openCloseBtn.onclick = ()=>{
  if(!gameRunning) return;
  endGame(true);
};

restartBtn.onclick = ()=>{
  finalBanner.style.display = "none";
  stopFireworks();
};

/* === Ø§Ù„Ù†Ù‚Ø§Ø· === */
function awardPoint(user){
  scores.set(user, (scores.get(user)||0)+1);
  updateScores();
}

/* === Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© === */
function endGame(stopped=false){
  gameRunning = false;
  acceptingAnswers = false;
  clearTimeout(answerTimeout);
  hideOverlay();

  openCloseBtn.style.display = "none";
  startGameBtn.style.display = "block";

  if(stopped){
    log("â›” ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù„Ø¹Ø¨Ø©.");
    return;
  }

  const arr = [...scores.entries()].sort((a,b)=>b[1]-a[1]);
  const topScore = arr[0]?.[1] ?? 0;
  const winners = arr.filter(x=>x[1]===topScore).map(x=>`@${x[0]}`);

  log(`ğŸ† Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ø§Ù„ÙØ§Ø¦Ø²: ${winners.join(" , ") || "Ù„Ø§ Ø£Ø­Ø¯"}`);
  showFinalCelebration(winners.join(" , ") || "Ù„Ø§ Ø£Ø­Ø¯", topScore);
}

/* === Ø±Ø¨Ø· Ø´Ø§Øª ØªÙˆÙŠØªØ´ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª === */
let client = null;

if(twitchToken && twitchUser && TWITCH_CLIENT_ID){
  client = new tmi.Client({
    options: { debug: false },
    identity: {
      username: twitchUser,
      password: "oauth:" + twitchToken
    },
    channels: [twitchUser]
  });

  client.connect()
    .then(()=> log(`âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø´Ø§Øª Ø¨Ù‚Ù†Ø§Ø© @${twitchUser}`))
    .catch(()=> log("âš ï¸ ÙØ´Ù„ Ø±Ø¨Ø· Ø§Ù„Ø´Ø§Øª"));

  client.on("message", (channel, tags, message, self)=>{
    if(self) return;
    if(!acceptingAnswers) return;

    const user = (tags.username||"").toLowerCase();
    const num = extractNumber(message);
    if(num === null) return;

    if(num === correctAnswer && !answeredThisRound){
      answeredThisRound = true;
      acceptingAnswers = false;

      awardPoint(user);
      log(`âœ… @${user} Ø¬Ø§ÙˆØ¨ ØµØ­! (+1 Ù†Ù‚Ø·Ø©)`);

      try{
        client.say(channel, `@${user} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! âœ…`);
      }catch{}

      clearTimeout(answerTimeout);
      hideOverlay();
      nextRound();
    }
  });
} else {
  log("â„¹ï¸ ÙˆØ¶Ø¹ ØªØ¬Ø±Ø¨Ø© Ø¨Ø¯ÙˆÙ† ØªÙˆÙŠØªØ´: Ø§Ù„Ù„Ø¹Ø¨Ø© ØªØ´ØªØºÙ„ Ù„ÙƒÙ† Ù…Ø§ ØªØ³ØªÙ‚Ø¨Ù„ Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ø´Ø§Øª.");
}

/* === Fireworks === */
function resizeFireworks(){
  fireworksCanvas.width = window.innerWidth;
  fireworksCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeFireworks);
resizeFireworks();

let fwParticles = [];
let fwRunning = false;
let fwTimer = null;

function spawnFirework(){
  const w = fireworksCanvas.width, h = fireworksCanvas.height;
  const x = Math.random()*w*0.9 + w*0.05;
  const y = Math.random()*h*0.35 + h*0.05;

  const colors = ["#2ad3d8","#15D0D4","#a84fb5","#7a2fb0","#ffffff"];
  const color = colors[Math.floor(Math.random()*colors.length)];

  const count = 60;
  for(let i=0;i<count;i++){
    const ang = (Math.PI*2*i)/count;
    const spd = Math.random()*3 + 2;
    fwParticles.push({
      x,y, vx: Math.cos(ang)*spd, vy: Math.sin(ang)*spd,
      life: Math.random()*40 + 40, color
    });
  }
}
function fireworksLoop(){
  if(!fwRunning) return;
  const w = fireworksCanvas.width, h = fireworksCanvas.height;
  fctx.clearRect(0,0,w,h);

  fwParticles.forEach(p=>{
    p.x += p.vx; p.y += p.vy; p.vy += 0.03; p.life--;
    fctx.globalAlpha = Math.max(0, p.life/80);
    fctx.beginPath(); fctx.arc(p.x,p.y,2.2,0,Math.PI*2);
    fctx.fillStyle = p.color; fctx.fill();
  });

  fwParticles = fwParticles.filter(p=>p.life>0);
  requestAnimationFrame(fireworksLoop);
}
function startFireworks(durationMs=6500){
  fwParticles = []; fwRunning = true;
  fireworksCanvas.style.display="block";
  spawnFirework();
  fwTimer = setInterval(spawnFirework, 650);
  fireworksLoop();
  setTimeout(stopFireworks, durationMs);
}
function stopFireworks(){
  fwRunning = false; fireworksCanvas.style.display="none";
  if(fwTimer) clearInterval(fwTimer); fwTimer = null;
}
function showFinalCelebration(winnerNames, pts){
  startFireworks();
  finalText.textContent = `ğŸ† Ø§Ù„ÙØ§Ø¦Ø²: ${winnerNames} â€” Ù†Ù‚Ø§Ø·Ù‡: ${pts}`;
  finalBanner.style.display="flex";
}

/* Boot log */
log("ğŸ® Ø¬Ù‡Ù‘Ø² Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ø¶ØºØ· (Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©).");
</script>

<!-- Ø§Ù„Ù‡ÙŠØ¯Ø±: ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨ ØªÙˆÙŠØªØ´ -->
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const userName   = document.getElementById("twitchUsername");
  const userAvatar = document.getElementById("twitchAvatar");

  if(!twitchToken || !twitchUser){
    userName.textContent = "ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„";
    userAvatar.src = "https://placehold.co/32x32?text=?";
    return;
  }

  try{
    const res = await fetch(`https://api.twitch.tv/helix/users?login=${twitchUser}`, {
      headers:{
        "Client-ID": TWITCH_CLIENT_ID,
        "Authorization": `Bearer ${twitchToken}`
      }
    });

    const data = await res.json();
    if(data.data?.length){
      userName.textContent = data.data[0].display_name;
      userAvatar.src = data.data[0].profile_image_url;
    }
  }catch{
    userName.textContent = twitchUser;
    userAvatar.src = "https://placehold.co/32x32?text=?";
  }
});
</script>

<footer class="foot"> 2O25 ViRUS, All Rights Reserved Â© </footer>

</body>
</html>
